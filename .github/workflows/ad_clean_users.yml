---
    name: AD User Account Cleanup
    
    on:
      workflow_dispatch:
        inputs:
          target_domain:
            type: choice
            description: Which domain to run against
            default: DEVTEST
            options:
              - DEVTEST
              - PROD     
          dry_run:
            description: 'Dry Run Mode'
            required: true
            default: 'True'
            type: choice
            options:
              - 'True'
              - 'False'
    
    permissions:
      id-token: write
      contents: read

    run-name: "AD User Account Cleanup (${{ inputs.target_domain }}) (DRY_RUN = ${{ inputs.dry_run }})"
    
    jobs:
      run-script-with-dry-run:
        runs-on: ubuntu-latest
        permissions:
          id-token: write
          contents: read
        
        steps:

        - name: Set environment variables from secrets
          run: |
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_ADMIN_INSTANCE_ID }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_SECRET_ARN }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_S3_BUCKET }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_ADMIN_INSTANCE_ID }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_SECRET_ARN }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_S3_BUCKET }}"
            case "${{ github.event.inputs.target_domain }}" in
              DEVTEST)
                echo "ADMIN_INSTANCE_ID=${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_ADMIN_INSTANCE_ID }}" >> $GITHUB_ENV
                echo "MODPLATFORM_SECRET_ARN=${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_SECRET_ARN }}" >> $GITHUB_ENV
                echo "S3_BUCKET=${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_S3_BUCKET }}" >> $GITHUB_ENV                
              ;;
              PROD)
                echo "ADMIN_INSTANCE_ID=${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_ADMIN_INSTANCE_ID }}" >> $GITHUB_ENV
                echo "MODPLATFORM_SECRET_ARN=${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_SECRET_ARN }}" >> $GITHUB_ENV                
                echo "S3_BUCKET=${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_S3_BUCKET }}" >> $GITHUB_ENV
              ;;
            esac
  
        - name: Checkout Repository
          uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
          with:
            ref: ${{ github.ref }}

        - name: Configure AWS credentials for Admin account
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: >- 
              arn:aws:iam::${{ github.event.inputs.target_domain == 'PROD' && secrets.AD_COMPUTER_MANAGEMENT_PROD_ADMIN_ACCOUNT_ID || secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_ADMIN_ACCOUNT_ID }}:role/modernisation-platform-oidc-cicd
            aws-region: "eu-west-2"

        - name: Refresh the aws secret
          id: refresh-secret
          run: |
            aws secretsmanager put-secret-value --secret-id $MODPLATFORM_SECRET_ARN --secret-string "${{ secrets.DSO_MODERNISATION_PLATFORM_AUTOMATION }}"
           
        - name: Copy and run the Pwsh script for AD User Management
          id: run-ad-clean-users
          run: |
              case "${{ github.event.inputs.target_domain }}" in
              DEVTEST)
                aws s3 cp src/ad_clean_users.ps1 "s3://$S3_BUCKET/aduserscript/ad_clean_users.ps1"

                COMMAND_ID=$(aws ssm send-command \
                  --document-name "AWS-RunPowerShellScript" \
                  --instance-ids "$ADMIN_INSTANCE_ID" \
                  --parameters 'commands=[
                  "aws s3 cp \"s3://'"$S3_BUCKET"'/aduserscript/ad_clean_users.ps1\" ad_clean_users.ps1",
                  "pwsh.exe -ExecutionPolicy Bypass -File ad_clean_users.ps1",
                  ]' \
                  --output text \
                  --comment "run-ad_clean_users.ps1" \
                  --query 'Command.CommandId')

                  echo "Command ID: $COMMAND_ID"
                  echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
                              
                ;;
              PROD)
                aws s3 cp src/ad_clean_users.ps1 "s3://$S3_BUCKET/aduserscript/ad_clean_users.ps1"

                COMMAND_ID=$(aws ssm send-command \
                  --document-name "AWS-RunPowerShellScript" \
                  --instance-ids "$ADMIN_INSTANCE_ID" \
                  --parameters 'commands=[
                  "aws s3 cp \"s3://'"$S3_BUCKET"'/aduserscript/ad_clean_users.ps1\" ad_clean_users.ps1",
                  "pwsh.exe -ExecutionPolicy Bypass -File ad_clean_users.ps1 -UserOU 'OU=RBAC' -ServiceAccountsOUPaths 'OU=SERVICE_ACCOUNTS'",
                  ]' \
                  --output text \
                  --comment "run-ad_clean_users.ps1" \
                  --query 'Command.CommandId')

                  echo "Command ID: $COMMAND_ID"
                  echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
                  
                  ;;
              esac

        - name: Check the job status and create the artifact to review
          id: check-status-and-create-artifact
          run: |
              COMMAND_ID="${{ steps.run-ad-clean-users.outputs.command_id }}"

              # Wait for completion with timing
              echo "Waiting for ssm job to complete..."
              START_TIME=$(date +%s)
              
              aws ssm wait command-executed \
                --command-id "$COMMAND_ID" \
                --instance-id "$ADMIN_INSTANCE_ID"
              
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              
              echo "✓ SSM job completed in ${DURATION} seconds"
              
              # Get final SSM job status
              STATUS=$(aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$ADMIN_INSTANCE_ID" \
                --query 'Status' \
                --output text)
              
              echo "Final SSM job status: $STATUS"

              mkdir -p ssm-output
              
              # # Get the command invocation details
              # aws ssm get-command-invocation \
              #   --command-id "$COMMAND_ID" \
              #   --instance-id "$ADMIN_INSTANCE_ID" \
              #   --output json > ssm-output/invocation.json
              
              # Extract stdout and stderr to separate files
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$ADMIN_INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text > ssm-output/stdout.txt
              
              # aws ssm get-command-invocation \
              #   --command-id "$COMMAND_ID" \
              #   --instance-id "$ADMIN_INSTANCE_ID" \
              #   --query 'StandardErrorContent' \
              #   --output text > ssm-output/stderr.txt

        - name: Upload review Artifact
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: aduserscript-logs-run-${{ github.run_number }}
            path: ssm-output/
            retention-days: 3

        - name: Manual review message
          run: |
            echo "⚠️  WARNING - USER ACCOUNTS TO BE DELETED:"
            echo ""
            echo "Please review the artifact before approving deletion."             

      # Manual approval stage
      approval-gate:
        runs-on: ubuntu-latest
        needs: run-script-with-dry-run
        environment: generic-dso-manual-approval  # Generic approval environment

        steps:
          - name: Approval checkpoint
            run: |
              echo "✅ Deletion approved for (${{ inputs.target_domain }}) domain"

      delete-verified-inactive-users:
        needs: [run-script-with-dry-run, approval-gate]
        runs-on: ubuntu-latest
        permissions:
          id-token: write
          contents: read
        
        steps:

        - name: Set environment variables from secrets
          id: set_vars
          run: |
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_AD_SERVICE_ACCOUNT }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_AD_SERVICE_ACCOUNT_SECRET_ARN }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_S3_BUCKET }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_AD_SERVICE_ACCOUNT }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_AD_SERVICE_ACCOUNT_SECRET_ARN }}"
            echo "::add-mask::${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_S3_BUCKET }}"
            case "${{ github.event.inputs.target_domain }}" in
              DEVTEST)
                echo "ADMIN_INSTANCE_ID=${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_ADMIN_INSTANCE_ID }}" >> $GITHUB_ENV
                echo "AD_SERVICE_ACCOUNT=${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_AD_SERVICE_ACCOUNT }}" >> $GITHUB_ENV
                echo "AD_SERVICE_ACCOUNT_SECRET_ARN=${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_AD_SERVICE_ACCOUNT_SECRET_ARN }}" >> $GITHUB_ENV
                echo "S3_BUCKET=${{ secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_S3_BUCKET }}" >> $GITHUB_ENV
              ;;
              PROD)
                echo "ADMIN_INSTANCE_ID=${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_ADMIN_INSTANCE_ID }}" >> $GITHUB_ENV
                echo "AD_SERVICE_ACCOUNT=${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_AD_SERVICE_ACCOUNT }}" >> $GITHUB_ENV
                echo "AD_SERVICE_ACCOUNT_SECRET_ARN=${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_AD_SERVICE_ACCOUNT_SECRET_ARN }}" >> $GITHUB_ENV
                echo "S3_BUCKET=${{ secrets.AD_COMPUTER_MANAGEMENT_PROD_S3_BUCKET }}" >> $GITHUB_ENV
              ;;
            esac

            echo "CURRENT_DATE=$(date +"%d-%m-%y")" >> $GITHUB_ENV

        - name: Checkout Repository
          uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
          with:
            ref: ${{ github.ref }}

        - name: Configure AWS credentials for Admin account
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: >- 
              arn:aws:iam::${{ github.event.inputs.target_domain == 'PROD' && secrets.AD_COMPUTER_MANAGEMENT_PROD_ADMIN_ACCOUNT_ID || secrets.AD_COMPUTER_MANAGEMENT_DEVTEST_ADMIN_ACCOUNT_ID }}:role/modernisation-platform-oidc-cicd
            aws-region: "eu-west-2"

        - name: Copy and run the Pwsh script for AD User Management
          id: run-ad-clean-users-approved
          run: |
              case "${{ github.event.inputs.target_domain }}" in
              DEVTEST)
                aws s3 cp src/ad_clean_users.ps1 "s3://$S3_BUCKET/aduserscript/ad_clean_users.ps1"

                COMMAND_ID=$(aws ssm send-command \
                  --document-name "AWS-RunPowerShellScript" \
                  --instance-ids "$ADMIN_INSTANCE_ID" \
                  --parameters 'commands=[
                  "aws s3 cp \"s3://'"$S3_BUCKET"'/aduserscript/ad_clean_users.ps1\" ad_clean_users.ps1 -DryRun $${{ inputs.dry_run }}",
                  "pwsh.exe -ExecutionPolicy Bypass -File ad_clean_users.ps1",
                  ]' \
                  --output text \
                  --comment "run-ad_clean_users.ps1" \
                  --query 'Command.CommandId')

                  echo "Command ID: $COMMAND_ID"
                  echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
                              
                ;;
              PROD)
                aws s3 cp src/ad_clean_users.ps1 "s3://$S3_BUCKET/aduserscript/ad_clean_users.ps1"

                COMMAND_ID=$(aws ssm send-command \
                  --document-name "AWS-RunPowerShellScript" \
                  --instance-ids "$ADMIN_INSTANCE_ID" \
                  --parameters 'commands=[
                  "aws s3 cp \"s3://'"$S3_BUCKET"'/aduserscript/ad_clean_users.ps1\" ad_clean_users.ps1",
                  "pwsh.exe -ExecutionPolicy Bypass -File ad_clean_users.ps1 -UserOU 'OU=RBAC' -ServiceAccountsOUPaths 'OU=SERVICE_ACCOUNTS' -DryRun $${{ inputs.dry_run }}",
                  ]' \
                  --output text \
                  --comment "run-ad_clean_users.ps1" \
                  --query 'Command.CommandId')

                  echo "Command ID: $COMMAND_ID"
                  echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
                  
                  ;;
              esac

        - name: Check the job status and create the final artifact to review
          id: check-status-and-create-artifact
          run: |
              COMMAND_ID="${{ steps.run-ad-clean-users-approved.outputs.command_id }}"

              # Wait for completion with timing
              echo "Waiting for ssm job to complete..."
              START_TIME=$(date +%s)
              
              aws ssm wait command-executed \
                --command-id "$COMMAND_ID" \
                --instance-id "$ADMIN_INSTANCE_ID"
              
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              
              echo "✓ SSM job completed in ${DURATION} seconds"
              
              # Get final SSM job status
              STATUS=$(aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$ADMIN_INSTANCE_ID" \
                --query 'Status' \
                --output text)
              
              echo "Final SSM job status: $STATUS"

              mkdir -p ssm-output
              
              # Extract stdout and stderr to separate files
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$ADMIN_INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text > ssm-output/stdout.txt
              
        - name: Upload Final Artifact
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: aduserscript-logs-approved-run-${{ github.run_number }}
            path: ssm-output/
            retention-days: 30
            